name: Build and Push Docker Image

on:
  push:
    tags:
      - 'v*.*.*'  # Trigger on version tags like v1.0.3

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
      
      - name: Extract version from tag
        id: version
        run: |
          # Extract tag name (e.g., v1.0.3)
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Building version: ${VERSION}"
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to Aliyun Container Registry
        run: |
          echo "${{ secrets.ALIYUN_REGISTRY_PASSWORD }}" | docker login \
            --username "${{ secrets.ALIYUN_REGISTRY_USERNAME }}" \
            --password-stdin \
            crpi-p4hwwrt00km3axuk.cn-shanghai.personal.cr.aliyuncs.com
      
      - name: Build Docker image
        run: |
          VERSION=${{ steps.version.outputs.version }}
          docker build \
            --build-arg VERSION=${VERSION} \
            -t crpi-p4hwwrt00km3axuk.cn-shanghai.personal.cr.aliyuncs.com/coderio/coderio:${VERSION} \
            -t crpi-p4hwwrt00km3axuk.cn-shanghai.personal.cr.aliyuncs.com/coderio/coderio:latest \
            .
      
      - name: Push Docker image (versioned tag)
        run: |
          VERSION=${{ steps.version.outputs.version }}
          docker push crpi-p4hwwrt00km3axuk.cn-shanghai.personal.cr.aliyuncs.com/coderio/coderio:${VERSION}
      
      - name: Push Docker image (latest tag)
        run: |
          docker push crpi-p4hwwrt00km3axuk.cn-shanghai.personal.cr.aliyuncs.com/coderio/coderio:latest
      
      - name: Image build summary
        run: |
          VERSION=${{ steps.version.outputs.version }}
          echo "âœ… Successfully built and pushed Docker images:"
          echo "  - crpi-p4hwwrt00km3axuk.cn-shanghai.personal.cr.aliyuncs.com/coderio/coderio:${VERSION}"
          echo "  - crpi-p4hwwrt00km3axuk.cn-shanghai.personal.cr.aliyuncs.com/coderio/coderio:latest"
